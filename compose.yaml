# TrueNAS MAAS Application - Docker Compose Configuration
# Version: 1.0.0
# TrueNAS Minimum Version: 25.10.0
#
# This Docker Compose configuration deploys MAAS (Metal as a Service) on TrueNAS
# with production-ready settings including health checks, non-root containers,
# and proper volume management.

name: maas

services:
  # PostgreSQL Database Service
  # Provides persistent data storage for MAAS region controller
  # Custom build with uid/gid 1000 support for TrueNAS 25.10+
  postgres:
    # Build custom PostgreSQL image with TrueNAS-compatible uid/gid
    build:
      context: .
      dockerfile: docker/postgres.Dockerfile
      args:
        POSTGRES_UID: 1000
        POSTGRES_GID: 1000
    image: ${POSTGRES_IMAGE_REPOSITORY:-truenas-maas-postgres}:${POSTGRES_IMAGE_TAG:-15}
    container_name: maas-postgres
    restart: unless-stopped

    # Run as non-root user (TrueNAS 25.10+ requirement)
    user: "1000:1000"

    # Environment configuration
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-maasdb}
      - POSTGRES_USER=${POSTGRES_USER:-maas}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - PGDATA=/var/lib/postgresql/data/pgdata
      - TZ=${TZ:-Etc/UTC}
      # Performance tuning
      - POSTGRES_INITDB_ARGS=${POSTGRES_INITDB_ARGS:--E UTF8 --locale=C}

    # Persistent volume for database data
    volumes:
      - ${POSTGRES_DATA_PATH:-/mnt/tank/maas/postgres}:/var/lib/postgresql/data:rw

    # Health check for database readiness
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-maas} -d ${POSTGRES_DB:-maasdb}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Logging configuration with rotation
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres"

    # Security: Drop all capabilities, no privileged mode
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

    # Network isolation
    networks:
      - maas-internal

    # Shared memory size for PostgreSQL
    # Increase for larger databases and concurrent connections
    shm_size: 256mb

  # MAAS Region Controller Service
  # Provides web UI, API, and manages physical infrastructure
  maas:
    # Build from custom Dockerfile optimized for TrueNAS
    build:
      context: .
      dockerfile: Dockerfile
      args:
        MAAS_VERSION: ${MAAS_VERSION:-3.5}
        MAAS_UID: 1000
        MAAS_GID: 1000
    image: ${IMAGE_REPOSITORY:-truenas-maas}:${IMAGE_TAG:-3.5}
    container_name: maas-region
    restart: unless-stopped

    # Run as non-root user (TrueNAS 25.10+ requirement)
    user: "1000:1000"

    # Network configuration
    # IMPORTANT: For PXE boot functionality, MAAS requires host network mode
    # Default is host mode. For testing without PXE, you can use bridge mode.
    # To use bridge mode: Set NETWORK_MODE=bridge in .env and uncomment the
    # 'networks' section below (and comment out network_mode)
    network_mode: host  # Change to 'bridge' if not using PXE boot

    # Port mappings (only used in bridge mode)
    # In host mode, these are ignored and MAAS uses default ports directly
    ports:
      - "${MAAS_HTTP_PORT:-5240}:5240"        # HTTP UI/API
      - "${MAAS_HTTPS_PORT:-5443}:5443"       # HTTPS UI/API
      - "${TFTP_PORT:-69}:69/udp"             # TFTP for PXE boot
      - "${PROXY_PORT:-8000}:8000"            # HTTP proxy for image downloads

    # Environment variables for MAAS configuration
    environment:
      # Timezone
      - TZ=${TZ:-Etc/UTC}

      # MAAS Core Configuration
      - MAAS_URL=${MAAS_URL:?MAAS_URL is required - e.g., http://192.168.1.100:5240/MAAS}
      - MAAS_ADMIN_USERNAME=${MAAS_ADMIN_USERNAME:-admin}
      - MAAS_ADMIN_PASSWORD=${MAAS_ADMIN_PASSWORD:?MAAS_ADMIN_PASSWORD is required}
      - MAAS_ADMIN_EMAIL=${MAAS_ADMIN_EMAIL:?MAAS_ADMIN_EMAIL is required}

      # Database Connection
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-maasdb}
      - POSTGRES_USER=${POSTGRES_USER:-maas}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}

      # MAAS Region Controller Settings
      - MAAS_REGION_SECRET=${MAAS_REGION_SECRET:-}
      - MAAS_DEBUG=${MAAS_DEBUG:-false}

      # Network Configuration
      - MAAS_DNS_FORWARDER=${MAAS_DNS_FORWARDER:-8.8.8.8}
      - MAAS_UPSTREAM_DNS=${MAAS_UPSTREAM_DNS:-8.8.8.8 8.8.4.4}

      # Image Configuration
      - MAAS_BOOT_IMAGES_AUTO_IMPORT=${MAAS_BOOT_IMAGES_AUTO_IMPORT:-true}
      - MAAS_IMAGES_KEYRING_FILEPATH=${MAAS_IMAGES_KEYRING_FILEPATH:-/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg}

    # Volume mounts for persistent data
    volumes:
      # Configuration files
      - ${MAAS_CONFIG_PATH:-/mnt/tank/maas/config}:/etc/maas:rw

      # Application data
      - ${MAAS_DATA_PATH:-/mnt/tank/maas/data}:/var/lib/maas:rw

      # Boot images (requires significant space - 100GB+)
      - ${MAAS_IMAGES_PATH:-/mnt/tank/maas/images}:/var/lib/maas/boot-resources:rw

      # Log files
      - ${MAAS_LOGS_PATH:-/mnt/tank/maas/logs}:/var/log/maas:rw

      # Temporary files
      - ${MAAS_TMP_PATH:-/mnt/tank/maas/tmp}:/tmp:rw

    # Linux capabilities required for MAAS operations
    # NET_ADMIN: Network configuration (DHCP, DNS)
    # NET_RAW: Raw socket access for DHCP server
    # NET_BIND_SERVICE: Bind to privileged ports (< 1024)
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - NET_BIND_SERVICE

    # Drop unnecessary capabilities
    cap_drop:
      - SYS_ADMIN
      - SYS_MODULE
      - SYS_RAWIO
      - SYS_TIME
      - AUDIT_CONTROL
      - AUDIT_WRITE

    # Security options
    security_opt:
      - no-new-privileges:true

    # Health check for MAAS service readiness
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "http://localhost:5240/MAAS/api/2.0/version/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

    # Service dependencies
    # MAAS requires PostgreSQL to be healthy before starting
    depends_on:
      postgres:
        condition: service_healthy

    # Logging configuration with rotation
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=maas"

    # Graceful shutdown timeout (TrueNAS 25.10+ extended timeout support)
    stop_grace_period: 120s

    # Networks
    # NOTE: Networks are only used when network_mode is NOT set to 'host'
    # When using host network mode, this section is ignored
    # Uncomment the line below if using bridge mode (set NETWORK_MODE=bridge in .env)
    # networks:
    #   - maas-internal

# Network definitions
networks:
  # Internal network for service communication
  maas-internal:
    driver: bridge
    name: maas-internal
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

# Volume definitions (optional - using host paths directly)
# These are declared for documentation purposes
volumes:
  maas-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAAS_CONFIG_PATH:-/mnt/tank/maas/config}

  maas-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAAS_DATA_PATH:-/mnt/tank/maas/data}

  maas-images:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAAS_IMAGES_PATH:-/mnt/tank/maas/images}

  maas-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MAAS_LOGS_PATH:-/mnt/tank/maas/logs}

  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_DATA_PATH:-/mnt/tank/maas/postgres}

# Configuration Notes:
#
# PostgreSQL Configuration:
#   This application uses a custom PostgreSQL image to support TrueNAS 25.10+ requirements.
#   The custom image runs PostgreSQL with uid/gid 1000, resolving the non-root user conflict.
#   For details, see: POSTGRESQL-SETUP.md
#
# Required Environment Variables:
#   - MAAS_URL: Full URL where MAAS will be accessible (e.g., http://192.168.1.100:5240/MAAS)
#   - MAAS_ADMIN_PASSWORD: Administrator password (minimum 8 characters)
#   - MAAS_ADMIN_EMAIL: Administrator email address
#   - POSTGRES_PASSWORD: PostgreSQL database password (minimum 8 characters)
#
# Optional Environment Variables:
#   - IMAGE_REPOSITORY: Docker image repository (default: maasio/maas)
#   - IMAGE_TAG: Docker image tag (default: 3.5)
#   - NETWORK_MODE: Network mode - host or bridge (default: host for PXE boot)
#   - TZ: Timezone (default: Etc/UTC)
#   - MAAS_HTTP_PORT: HTTP port (default: 5240, only in bridge mode)
#   - POSTGRES_DB: Database name (default: maasdb)
#   - POSTGRES_USER: Database user (default: maas)
#
# Storage Requirements:
#   - Config: ~100MB
#   - Data: ~10GB minimum
#   - Images: 100GB+ (depends on number of OS images imported)
#   - Logs: 5GB recommended
#   - PostgreSQL: 20GB minimum
#   - Total: ~135GB minimum
#
# Network Mode Selection:
#   - host: Required for PXE boot/DHCP functionality (recommended for production)
#   - bridge: Isolated network, suitable for testing or API-only access
#
# Pre-Installation Steps:
#   1. Create storage directories with proper ownership:
#      mkdir -p /mnt/tank/maas/{config,data,images,logs,tmp,postgres}
#      chown -R 1000:1000 /mnt/tank/maas/
#      chmod -R 755 /mnt/tank/maas/
#
#   2. Create .env file with required variables:
#      MAAS_URL=http://192.168.1.100:5240/MAAS
#      MAAS_ADMIN_PASSWORD=your-secure-password
#      MAAS_ADMIN_EMAIL=admin@example.com
#      POSTGRES_PASSWORD=your-database-password
#
#   3. Start services:
#      docker compose up -d
#
#   4. Monitor startup:
#      docker compose logs -f maas
#
#   5. Access MAAS UI:
#      http://<truenas-ip>:5240/MAAS
#
# Post-Installation Steps:
#   1. Login to MAAS web UI with admin credentials
#   2. Import boot images: Settings > Images > Ubuntu > Select releases > Import
#   3. Configure DNS forwarder if needed
#   4. Add subnets and enable DHCP
#   5. Enroll physical machines via IPMI/BMC or PXE boot
#
# Troubleshooting:
#   - Check logs: docker compose logs maas
#   - Check database: docker compose logs postgres
#   - Verify network mode matches requirements
#   - Ensure storage paths are accessible and have correct permissions
#   - Check firewall rules allow required ports
#
# Security Best Practices:
#   - Use strong passwords (16+ characters, mixed case, numbers, symbols)
#   - Store sensitive variables in .env file (never commit to git)
#   - Restrict network access to MAAS UI (use firewall or reverse proxy)
#   - Enable HTTPS with valid TLS certificates in production
#   - Regularly update MAAS and PostgreSQL images
#   - Monitor logs for suspicious activity
#   - Back up PostgreSQL database regularly
#
# Backup Procedure:
#   1. Stop MAAS service: docker compose stop maas
#   2. Backup database:
#      docker compose exec postgres pg_dump -U maas maasdb > backup.sql
#   3. Backup volumes:
#      tar -czf maas-backup.tar.gz /mnt/tank/maas/
#   4. Restart service: docker compose start maas
#
# Restore Procedure:
#   1. Stop all services: docker compose down
#   2. Restore volumes: tar -xzf maas-backup.tar.gz -C /
#   3. Start database: docker compose up -d postgres
#   4. Restore database:
#      docker compose exec -T postgres psql -U maas maasdb < backup.sql
#   5. Start all services: docker compose up -d
#
# For more information:
#   - MAAS Documentation: https://maas.io/docs
#   - TrueNAS Apps: https://www.truenas.com/docs/truenasapps/
#   - GitHub Repository: https://github.com/yourusername/truenas-maas-app
